name: Benchmark

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: write
  pull-requests: write

jobs:
  benchmark:
    name: Performance Benchmarks
    runs-on: macos-14

    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@60606e260d2fc5762a71e64e74b2174e8ea3c8bd # v1.6.0
        with:
          xcode-version: latest-stable

      - name: Cache Swift packages
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        with:
          path: .build
          key: ${{ runner.os }}-spm-benchmark-${{ hashFiles('Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-spm-benchmark-

      - name: Build Benchmark
        run: swift build -c release --product Benchmark

      - name: Run Benchmarks
        id: benchmark
        run: |
          # Run with --quick flag in CI to reduce time, use --json for output
          # Separate stdout (JSON) from stderr (logs/errors)
          timeout 180 .build/release/Benchmark --quick --json > benchmark-raw.json 2>benchmark-stderr.log || true

          echo "=== Benchmark stderr ==="
          cat benchmark-stderr.log || true

          echo "=== Raw benchmark output ==="
          head -100 benchmark-raw.json || true

          # Transform to github-action-benchmark format
          # Expected: [{"name": "...", "unit": "µs", "value": 123.45}, ...]
          if [ -s benchmark-raw.json ] && jq empty benchmark-raw.json 2>/dev/null; then
            jq '[.results | to_entries[] | .value[] | {name: "\(.operation)", unit: "µs", value: .avgUs}]' benchmark-raw.json > benchmark-results.json 2>/dev/null || echo "[]" > benchmark-results.json
            RESULT_COUNT=$(jq 'length' benchmark-results.json 2>/dev/null || echo "0")
            if [ "$RESULT_COUNT" -gt 0 ] 2>/dev/null; then
              echo "has_results=true" >> $GITHUB_OUTPUT
            else
              echo "has_results=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "[]" > benchmark-results.json
            echo "has_results=false" >> $GITHUB_OUTPUT
          fi

          echo "=== Final benchmark results ==="
          cat benchmark-results.json

      - name: Store Benchmark Results
        if: steps.benchmark.outputs.has_results == 'true'
        uses: benchmark-action/github-action-benchmark@4bdcce38c94cec68da58d012ac24b7b1155efe8b # v1.20.7
        with:
          name: MetalAudio Benchmarks
          tool: 'customSmallerIsBetter'
          output-file-path: benchmark-results.json
          github-token: ${{ secrets.GITHUB_TOKEN }}
          auto-push: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
          comment-on-alert: true
          alert-threshold: '150%'
          fail-on-alert: false
          max-items-in-chart: 50
          skip-fetch-gh-pages: ${{ github.event_name == 'pull_request' }}

      - name: Skip notice
        if: steps.benchmark.outputs.has_results != 'true'
        run: echo "⚠️ Benchmark skipped - no GPU available or benchmark failed"
